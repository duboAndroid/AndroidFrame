package com.ab.view.calendar;

import java.util.Calendar;

import android.content.Context;
import android.graphics.Canvas;
import android.graphics.Color;
import android.graphics.Paint;
import android.graphics.Path;
import android.graphics.RectF;
import android.view.KeyEvent;
import android.view.MotionEvent;
import android.view.View;
import android.view.animation.AlphaAnimation;
import android.widget.LinearLayout.LayoutParams;

import com.ab.view.AbOnItemClickListener;

/**
 * 
 * Copyright (c) 2012 All rights reserved
 * 名称：CalendarCell.java 
 * 描述：日历控件单元格绘制类
 * @author zhaoqp
 * @date：2013-7-9 下午3:54:16
 * @version v1.0
 */
public class CalendarCell extends View {
	
	// 字体大小
	private int textSize = 22;
	
	// 基本元素
	private AbOnItemClickListener mOnItemClickListener;
	private Paint pt = new Paint();
	private RectF rect = new RectF();
	
	//显示的文字
	private String textDateValue = "";

	// 当前日期
	private int iDateYear = 0;
	private int iDateMonth = 0;
	private int iDateDay = 0;

	// 布尔变量
	private boolean isSelected = false;
	private boolean isActiveMonth = false;
	private boolean isToday = false;
	private boolean bTouchedDown = false;
	private boolean isHoliday = false;
	private boolean hasRecord = false;
	
	//当前cell的序号
	private int position = 0;

	public static int ANIM_ALPHA_DURATION = 100;
	
	/*被选中的cell颜色*/
	private int selectCellColor = Color.rgb(150, 195, 70);
	
	/*最大背景颜色*/
	private int bgColor = Color.rgb(163,163, 163);
	
	/*数字颜色*/
	private int numberColor = Color.rgb(86, 86, 86);
	
	/*cell背景颜色*/
	private int cellColor = Color.WHITE;
	
	/*非本月的数字颜色*/
	private int notActiveMonthColor = Color.rgb(178, 178, 178);
	
	/*今天cell颜色*/
	private int todayColor = Color.rgb(150, 200, 220);
	

	// 构造函数
	public CalendarCell(Context context, int position,int iWidth, int iHeight) {
		super(context);
		setFocusable(true);
		setLayoutParams(new LayoutParams(iWidth, iHeight));
		this.position = position;
	}

	/**
	 * 描述：获取这个Cell的日期
	 * @return
	 */
	public Calendar getThisCellDate() {
		Calendar calDate = Calendar.getInstance();
		calDate.clear();
		calDate.set(Calendar.YEAR, iDateYear);
		calDate.set(Calendar.MONTH, iDateMonth);
		calDate.set(Calendar.DAY_OF_MONTH, iDateDay);
		return calDate;
	}

	/**
	 * 
	 * 描述：设置这个Cell的日期
	 * @param iYear
	 * @param iMonth
	 * @param iDay
	 * @param bToday
	 * @param bHoliday
	 * @param iActiveMonth
	 * @param hasRecord
	 */
	public void setThisCellDate(int iYear, int iMonth, int iDay, Boolean isToday,Boolean isSelected,
			Boolean isHoliday, int isActiveMonth, boolean hasRecord) {
		iDateYear = iYear;
		iDateMonth = iMonth;
		iDateDay = iDay;

		this.textDateValue = Integer.toString(iDateDay);
		this.isActiveMonth = (iDateMonth == isActiveMonth);
		this.isToday = isToday;
		this.isHoliday = isHoliday;
		this.hasRecord = hasRecord;
		this.isSelected = isSelected;
	}

	/**
	 * 描述：重载绘制方法
	 * @see android.view.View#onDraw(android.graphics.Canvas)
	 */
	@Override
	protected void onDraw(Canvas canvas) {
		super.onDraw(canvas);

		canvas.drawColor(bgColor);
		rect.set(0, 0, this.getWidth(), this.getHeight());
		rect.inset(0.5f, 0.5f);

		final boolean bFocused = IsViewFocused();

		drawDayView(canvas, bFocused);
		drawDayNumber(canvas);
	}

	public boolean IsViewFocused() {
		return (this.isFocused() || bTouchedDown);
	}

	/**
	 * 描述：绘制日历方格
	 * @param canvas
	 * @param bFocused
	 */
	private void drawDayView(Canvas canvas, boolean bFocused) {

		pt.setColor(getCellColor());
		canvas.drawRect(rect, pt);

		if (hasRecord) {
			createReminder(canvas,Color.RED);
		}
		
	}

	/**
	 * 描述：绘制日历中的数字
	 * @param canvas
	 */
	public void drawDayNumber(Canvas canvas) {
		// draw day number
		pt.setTypeface(null);
		pt.setAntiAlias(true);
		pt.setShader(null);
		pt.setFakeBoldText(true);
		pt.setTextSize(textSize);
		pt.setColor(numberColor);
		pt.setUnderlineText(false);
		
		if (!isActiveMonth){
			pt.setColor(notActiveMonthColor);
		}

		final int iPosX = (int) rect.left + ((int) rect.width() >> 1) - ((int) pt.measureText(textDateValue) >> 1);
		final int iPosY = (int) (this.getHeight() - (this.getHeight() - getTextHeight()) / 2 - pt.getFontMetrics().bottom);
		canvas.drawText(textDateValue, iPosX, iPosY, pt);
	}

	/**
	 * 描述：得到字体高度
	 */
	private int getTextHeight() {
		return (int) (-pt.ascent() + pt.descent());
	}

	/**
	 * 描述：根据条件返回不同颜色值
	 * @param bHoliday
	 * @param bToday
	 */
	public int getCellColor() {
		if (isToday){
			return todayColor;
		}
		
		if (isSelected){
			return selectCellColor;
		}
		
		//如需周末有特殊背景色
		if (isHoliday){
		   return cellColor;
		}
		
		//默认是白色的单元格
		return cellColor;
	}

	/**
	 * 描述：设置是否被选中
	 */
	@Override
	public void setSelected(boolean bEnable) {
		if (this.isSelected != bEnable) {
			this.isSelected = bEnable;
			this.invalidate();
		}
	}

	/**
	 * 
	 * 描述：设置点击事件
	 * @param onItemClickListener
	 */
	public void setOnItemClickListener(AbOnItemClickListener onItemClickListener) {
		this.mOnItemClickListener = onItemClickListener;
	}

	/**
	 * 描述：执行点击事件
	 */
	public void doItemClick() {
		if (mOnItemClickListener != null){
			mOnItemClickListener.onClick(position);
	    }
	}

	@Override
	public boolean onTouchEvent(MotionEvent event) {
		boolean bHandled = false;
		if (event.getAction() == MotionEvent.ACTION_DOWN) {
			bHandled = true;
			bTouchedDown = true;
			invalidate();
			startAlphaAnimIn(CalendarCell.this);
		}
		if (event.getAction() == MotionEvent.ACTION_CANCEL) {
			bHandled = true;
			bTouchedDown = false;
			invalidate();
		}
		if (event.getAction() == MotionEvent.ACTION_UP) {
			bHandled = true;
			bTouchedDown = false;
			invalidate();
			doItemClick();
		}
		return bHandled;
	}

	@Override
	public boolean onKeyDown(int keyCode, KeyEvent event) {
		boolean bResult = super.onKeyDown(keyCode, event);
		if ((keyCode == KeyEvent.KEYCODE_DPAD_CENTER)
				|| (keyCode == KeyEvent.KEYCODE_ENTER)) {
			doItemClick();
		}
		return bResult;
	}

	/**
	 * 描述：动画不透明度渐变
	 * @param view
	 */
	public static void startAlphaAnimIn(View view) {
		AlphaAnimation anim = new AlphaAnimation(0.5F, 1);
		anim.setDuration(ANIM_ALPHA_DURATION);
		anim.startNow();
		view.startAnimation(anim);
	}

	/**
	 * 
	 * 描述：有记录时的样子
	 * @param canvas
	 * @param Color
	 */
	public void createReminder(Canvas canvas, int Color) {
		pt.setUnderlineText(true);
		pt.setStyle(Paint.Style.FILL_AND_STROKE);
		pt.setColor(Color);
		Path path = new Path();
		path.moveTo(rect.right - rect.width() / 4, rect.top);
		path.lineTo(rect.right, rect.top);
		path.lineTo(rect.right, rect.top + rect.width() / 4);
		path.lineTo(rect.right - rect.width() / 4, rect.top);
		path.close();
		canvas.drawPath(path, pt);
		pt.setUnderlineText(false);
	}

	/**
	 * 
	 * 描述：是否为活动的月
	 * @return
	 */
	public boolean isActiveMonth() {
		return isActiveMonth;
	}
	
	
	
	
	
}